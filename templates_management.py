# templates_management.py - ÁÆ°ÁêÜÂäüËÉΩÊ®°Êùø

# ÂÑ≤Â≠òÁ©∫ÈñìÁÆ°ÁêÜÊ®°Êùø
STORAGE_MANAGEMENT_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíæ ÂÑ≤Â≠òÁ©∫ÈñìÁÆ°ÁêÜ - EMI Êô∫ËÉΩÊïôÂ≠∏Âä©ÁêÜ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .storage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .used { color: #e74c3c; }
        .available { color: #27ae60; }
        .total { color: #3498db; }
        .growth { color: #f39c12; }
        
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .storage-breakdown {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .data-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid;
            transition: transform 0.2s ease;
        }
        
        .category-item:hover {
            transform: translateX(5px);
        }
        
        .conversations { border-left-color: #3498db; }
        .analysis { border-left-color: #e74c3c; }
        .cache { border-left-color: #f39c12; }
        .exports { border-left-color: #9b59b6; }
        .logs { border-left-color: #2ecc71; }
        
        .category-icon {
            font-size: 1.5em;
            margin-right: 15px;
        }
        
        .category-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .category-size {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .management-actions {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .action-card {
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
        }
        
        .action-card h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .action-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .cleanup-safe { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
        .cleanup-aggressive { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .export-data { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .optimize { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        
        .alerts {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .recommendations {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .recommendation-item {
            display: flex;
            align-items: flex-start;
            padding: 20px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .recommendation-icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: #3498db;
        }
        
        .recommendation-content h4 {
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .recommendation-content p {
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .recommendation-action {
            background: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }
        
        .recommendation-action:hover {
            background: #2980b9;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <a href="/teaching-insights" class="back-btn">‚Üê ËøîÂõûÂàÜÊûêÂæåÂè∞</a>
    
    <div class="container">
        <div class="header">
            <h1>üíæ ÂÑ≤Â≠òÁ©∫ÈñìÁÆ°ÁêÜ</h1>
            <p>Áõ£ÊéßÁ≥ªÁµ±ÂÑ≤Â≠ò‰ΩøÁî®ÁãÄÊ≥ÅÔºåÂÑ™ÂåñÁ©∫ÈñìÈÖçÁΩÆ</p>
        </div>
        
        <!-- ÂÑ≤Â≠òÁµ±Ë®àÊ¶ÇË¶Ω -->
        <div class="storage-stats">
            <div class="stat-card">
                <div class="stat-value used">{{ storage_stats.used_gb }}GB</div>
                <div>Â∑≤‰ΩøÁî®Á©∫Èñì</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ storage_stats.usage_percentage }}%; background: linear-gradient(90deg, #e74c3c, #c0392b);"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value available">{{ storage_stats.available_gb }}GB</div>
                <div>ÂèØÁî®Á©∫Èñì</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ 100 - storage_stats.usage_percentage }}%; background: linear-gradient(90deg, #27ae60, #2ecc71);"></div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value total">{{ storage_stats.total_gb }}GB</div>
                <div>Á∏ΩÂÆπÈáè</div>
                <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">
                    ‰ΩøÁî®ÁéáÔºö{{ storage_stats.usage_percentage }}%
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value growth">+{{ storage_stats.daily_growth_mb }}MB</div>
                <div>Êó•ÂùáÂ¢ûÈï∑</div>
                <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 10px;">
                    È†ê‰º∞ {{ storage_stats.days_until_full }} Â§©ÂæåÊªøËºâ
                </div>
            </div>
        </div>
        
        <!-- Á©∫ÈñìÂàÜÂ∏ÉÂúñË°® -->
        <div class="storage-breakdown">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">üìä ÂÑ≤Â≠òÁ©∫ÈñìÂàÜÂ∏É</h2>
            <div class="chart-container">
                <canvas id="storageChart"></canvas>
            </div>
            
            <!-- Ë≥áÊñôÂàÜÈ°ûË©≥ÊÉÖ -->
            <div class="data-categories">
                <div class="category-item conversations">
                    <div class="category-icon">üí¨</div>
                    <div class="category-info">
                        <h4>Â∞çË©±Ë®òÈåÑ</h4>
                        <div class="category-size">{{ data_breakdown.conversations.size }} ({{ data_breakdown.conversations.percentage }}%)</div>
                    </div>
                </div>
                
                <div class="category-item analysis">
                    <div class="category-icon">üìà</div>
                    <div class="category-info">
                        <h4>ÂàÜÊûêÁµêÊûú</h4>
                        <div class="category-size">{{ data_breakdown.analysis.size }} ({{ data_breakdown.analysis.percentage }}%)</div>
                    </div>
                </div>
                
                <div class="category-item cache">
                    <div class="category-icon">‚ö°</div>
                    <div class="category-info">
                        <h4>Âø´ÂèñË≥áÊñô</h4>
                        <div class="category-size">{{ data_breakdown.cache.size }} ({{ data_breakdown.cache.percentage }}%)</div>
                    </div>
                </div>
                
                <div class="category-item exports">
                    <div class="category-icon">üìÅ</div>
                    <div class="category-info">
                        <h4>ÂåØÂá∫Ê™îÊ°à</h4>
                        <div class="category-size">{{ data_breakdown.exports.size }} ({{ data_breakdown.exports.percentage }}%)</div>
                    </div>
                </div>
                
                <div class="category-item logs">
                    <div class="category-icon">üìù</div>
                    <div class="category-info">
                        <h4>Á≥ªÁµ±Ë®òÈåÑ</h4>
                        <div class="category-size">{{ data_breakdown.logs.size }} ({{ data_breakdown.logs.percentage }}%)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÁÆ°ÁêÜÊìç‰Ωú -->
        <div class="management-actions">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">üõ†Ô∏è ÁÆ°ÁêÜÊìç‰Ωú</h2>
            <div class="action-grid">
                <button class="action-card cleanup-safe" onclick="safeCleanup()">
                    <h3>üßπ ÂÆâÂÖ®Ê∏ÖÁêÜ</h3>
                    <p>Ê∏ÖÁêÜËá®ÊôÇÊ™îÊ°àÂíåÈÅéÊúüÂø´Âèñ<br>È†êË®àÈáãÊîæÔºö{{ cleanup_estimates.safe }}MB</p>
                </button>
                
                <button class="action-card cleanup-aggressive" onclick="aggressiveCleanup()">
                    <h3>üî• Ê∑±Â∫¶Ê∏ÖÁêÜ</h3>
                    <p>Ê∏ÖÁêÜËàäÂ∞çË©±ÂíåÂàÜÊûêÁµêÊûú<br>È†êË®àÈáãÊîæÔºö{{ cleanup_estimates.aggressive }}MB</p>
                </button>
                
                <button class="action-card export-data" onclick="exportAndArchive()">
                    <h3>üì¶ ÂåØÂá∫Â≠òÊ™î</h3>
                    <p>ÂåØÂá∫ÈáçË¶ÅË≥áÊñôÂæåÊ∏ÖÁêÜ<br>È†êË®àÈáãÊîæÔºö{{ cleanup_estimates.archive }}MB</p>
                </button>
                
                <button class="action-card optimize" onclick="optimizeStorage()">
                    <h3>‚ö° ÂÑ™ÂåñÂÑ≤Â≠ò</h3>
                    <p>Â£ìÁ∏ÆÂíåÈáçÁµÑË≥áÊñôÂ∫´<br>È†êË®àÂÑ™ÂåñÔºö{{ cleanup_estimates.optimize }}MB</p>
                </button>
            </div>
        </div>
        
        <!-- Ë≠¶ÂëäÂíåÊèêÈÜí -->
        {% if alerts %}
        <div class="alerts">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">‚ö†Ô∏è Á≥ªÁµ±ÊèêÈÜí</h2>
            {% for alert in alerts %}
            <div class="alert alert-{{ alert.type }}">
                <strong>{{ alert.title }}</strong><br>
                {{ alert.message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- ÂÑ™ÂåñÂª∫Ë≠∞ -->
        <div class="recommendations">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">üí° ÂÑ™ÂåñÂª∫Ë≠∞</h2>
            
            <div class="recommendation-item">
                <div class="recommendation-icon">üîÑ</div>
                <div class="recommendation-content">
                    <h4>ÂÆöÊúüÊ∏ÖÁêÜÂø´Âèñ</h4>
                    <p>Âª∫Ë≠∞ÊØèÈÄ±Ê∏ÖÁêÜ‰∏ÄÊ¨°Á≥ªÁµ±Âø´ÂèñÔºåÂèØÈáãÊîæÁ¥Ñ {{ recommendations.cache_cleanup }}MB Á©∫Èñì</p>
                    <button class="recommendation-action" onclick="scheduleCleanup()">Ë®≠ÂÆöËá™ÂãïÊ∏ÖÁêÜ</button>
                </div>
            </div>
            
            <div class="recommendation-item">
                <div class="recommendation-icon">üìö</div>
                <div class="recommendation-content">
                    <h4>Â≠òÊ™îËàäÂ∞çË©±</h4>
                    <p>Â∞á 30 Â§©ÂâçÁöÑÂ∞çË©±Ë®òÈåÑÂ≠òÊ™îÔºå‰øùÁïôÈáçË¶ÅÂ≠∏ÁøíË≥áÊñôÂêåÊôÇÁØÄÁúÅÁ©∫Èñì</p>
                    <button class="recommendation-action" onclick="archiveOldConversations()">ÈñãÂßãÂ≠òÊ™î</button>
                </div>
            </div>
            
            <div class="recommendation-item">
                <div class="recommendation-icon">‚öôÔ∏è</div>
                <div class="recommendation-content">
                    <h4>Ë™øÊï¥ÂÑ≤Â≠òÁ≠ñÁï•</h4>
                    <p>ÂÑ™ÂåñË≥áÊñôÂÑ≤Â≠òÊñπÂºèÔºåÊèêÂçáÁ≥ªÁµ±ÊïàËÉΩ‰∏¶Ê∏õÂ∞ëÁ©∫Èñì‰ΩîÁî®</p>
                    <button class="recommendation-action" onclick="optimizeStrategy()">Êü•ÁúãË®≠ÂÆö</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ÂÑ≤Â≠òÁ©∫ÈñìÂàÜÂ∏ÉÂúñË°®
        const ctx = document.getElementById('storageChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Â∞çË©±Ë®òÈåÑ', 'ÂàÜÊûêÁµêÊûú', 'Âø´ÂèñË≥áÊñô', 'ÂåØÂá∫Ê™îÊ°à', 'Á≥ªÁµ±Ë®òÈåÑ'],
                datasets: [{
                    data: [
                        {{ data_breakdown.conversations.percentage }},
                        {{ data_breakdown.analysis.percentage }},
                        {{ data_breakdown.cache.percentage }},
                        {{ data_breakdown.exports.percentage }},
                        {{ data_breakdown.logs.percentage }}
                    ],
                    backgroundColor: [
                        '#3498db',
                        '#e74c3c',
                        '#f39c12',
                        '#9b59b6',
                        '#2ecc71'
                    ],
                    borderWidth: 3,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
        
        // ÁÆ°ÁêÜÊìç‰ΩúÂáΩÊï∏
        function safeCleanup() {
            if (confirm('Á¢∫ÂÆöË¶ÅÈÄ≤Ë°åÂÆâÂÖ®Ê∏ÖÁêÜÂóéÔºüÈÄôÂ∞áÊ∏ÖÁêÜËá®ÊôÇÊ™îÊ°àÂíåÈÅéÊúüÂø´Âèñ„ÄÇ')) {
                showProgress('Ê≠£Âú®ÈÄ≤Ë°åÂÆâÂÖ®Ê∏ÖÁêÜ...', 'cleanup/safe');
            }
        }
        
        function aggressiveCleanup() {
            if (confirm('Ë≠¶ÂëäÔºöÊ∑±Â∫¶Ê∏ÖÁêÜÂ∞áÂà™Èô§ËàäÁöÑÂ∞çË©±Ë®òÈåÑÂíåÂàÜÊûêÁµêÊûúÔºåÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Âæ©„ÄÇÁ¢∫ÂÆöÁπºÁ∫åÂóéÔºü')) {
                showProgress('Ê≠£Âú®ÈÄ≤Ë°åÊ∑±Â∫¶Ê∏ÖÁêÜ...', 'cleanup/aggressive');
            }
        }
        
        function exportAndArchive() {
            showProgress('Ê≠£Âú®ÂåØÂá∫‰∏¶Â≠òÊ™îË≥áÊñô...', 'export/archive');
        }
        
        function optimizeStorage() {
            showProgress('Ê≠£Âú®ÂÑ™ÂåñÂÑ≤Â≠òÁµêÊßã...', 'optimize/storage');
        }
        
        function scheduleCleanup() {
            showProgress('Ê≠£Âú®Ë®≠ÂÆöËá™ÂãïÊ∏ÖÁêÜÊéíÁ®ã...', 'schedule/cleanup');
        }
        
        function archiveOldConversations() {
            showProgress('Ê≠£Âú®Â≠òÊ™îËàäÂ∞çË©±Ë®òÈåÑ...', 'archive/conversations');
        }
        
        function optimizeStrategy() {
            window.location.href = '/storage-settings';
        }
        
        function showProgress(message, endpoint) {
            // È°ØÁ§∫ÈÄ≤Â∫¶ÊèêÁ§∫
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                z-index: 1000;
            `;
            progressDiv.innerHTML = `
                <div style="font-size: 1.2em; margin-bottom: 20px;">${message}</div>
                <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;">
                    <div style="width: 0%; height: 100%; background: #3498db; border-radius: 2px; transition: width 3s ease;" id="progressBar"></div>
                </div>
            `;
            document.body.appendChild(progressDiv);
            
            // Ê®°Êì¨ÈÄ≤Â∫¶
            setTimeout(() => {
                document.getElementById('progressBar').style.width = '100%';
            }, 100);
            
            // 3ÁßíÂæåÁßªÈô§‰∏¶ÈáçÊñ∞ËºâÂÖ•
            setTimeout(() => {
                document.body.removeChild(progressDiv);
                window.location.reload();
            }, 3000);
        }
        
        // Âç≥ÊôÇÊõ¥Êñ∞ÂÑ≤Â≠òÁãÄÊÖãÔºàÊØè30ÁßíÔºâ
        setInterval(() => {
            fetch('/api/storage-status')
                .then(response => response.json())
                .then(data => {
                    // Êõ¥Êñ∞È°ØÁ§∫ÁöÑÊï∏Êìö
                    console.log('ÂÑ≤Â≠òÁãÄÊÖãÂ∑≤Êõ¥Êñ∞', data);
                })
                .catch(error => console.error('Êõ¥Êñ∞Â§±Êïó:', error));
        }, 30000);
    </script>
</body>
</html>
"""

# Ë≥áÊñôÂåØÂá∫Ê®°Êùø
DATA_EXPORT_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Ë≥áÊñôÂåØÂá∫‰∏≠ÂøÉ - EMI Êô∫ËÉΩÊïôÂ≠∏Âä©ÁêÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 2.5em;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .export-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .export-card:hover {
            transform: translateY(-5px);
        }
        
        .export-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }
        
        .export-card h3::before {
            content: attr(data-icon);
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .format-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .format-btn {
            padding: 8px 15px;
            border: 2px solid #3498db;
            background: transparent;
            color: #3498db;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }
        
        .format-btn:hover {
            background: #3498db;
            color: white;
        }
        
        .format-btn.selected {
            background: #3498db;
            color: white;
        }
        
        .date-range {
            margin: 20px 0;
        }
        
        .date-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .date-inputs input {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .date-inputs input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .export-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(52, 152, 219, 0.3);
        }
        
        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .progress-icon {
            font-size: 1.5em;
            margin-right: 15px;
        }
        
        .progress-info {
            flex: 1;
        }
        
        .progress-bar {
            background: #ecf0f1;
            border-radius: 10px;
            height: 8px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2980b9);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .status-complete { border-left-color: #27ae60; }
        .status-processing { border-left-color: #f39c12; }
        .status-pending { border-left-color: #95a5a6; }
        .status-error { border-left-color: #e74c3c; }
        
        .download-link {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }
        
        .download-link:hover {
            background: #2ecc71;
        }
        
        .history-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            transition: background 0.3s ease;
        }
        
        .history-item:hover {
            background: #e9ecef;
        }
        
        .history-info h4 {
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .history-meta {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }
        
        .btn-download {
            background: #3498db;
            color: white;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-share {
            background: #f39c12;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 12px 20px;
            border-radius: 25px;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .back-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .advanced-options {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .option-group {
            margin-bottom: 20px;
        }
        
        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
        }
        
        .checkbox-item input {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <a href="/teaching-insights" class="back-btn">‚Üê ËøîÂõûÂàÜÊûêÂæåÂè∞</a>
    
    <div class="container">
        <div class="header">
            <h1>üìä Ë≥áÊñôÂåØÂá∫‰∏≠ÂøÉ</h1>
            <p>ÂåØÂá∫ÊïôÂ≠∏Ë≥áÊñôÔºåÊîØÊè¥Â§öÁ®ÆÊ†ºÂºèÂíåËá™Ë®ÇÈÅ∏È†Ö</p>
        </div>
        
        <!-- ÂåØÂá∫ÈÅ∏È†Ö -->
        <div class="export-options">
            <!-- Â≠∏ÁîüÂ∞çË©±Ë®òÈåÑ -->
            <div class="export-card">
                <h3 data-icon="üí¨">Â≠∏ÁîüÂ∞çË©±Ë®òÈåÑ</h3>
                <p>ÂåØÂá∫ÊâÄÊúâÂ≠∏ÁîüÁöÑÂ∞çË©±Ê≠∑Âè≤Âíå‰∫íÂãïË®òÈåÑ</p>
                
                <div class="format-options">
                    <button class="format-btn selected" data-format="csv">CSV</button>
                    <button class="format-btn" data-format="excel">Excel</button>
                    <button class="format-btn" data-format="json">JSON</button>
                    <button class="format-btn" data-format="pdf">PDF</button>
                </div>
                
                <div class="date-range">
                    <label>Êó•ÊúüÁØÑÂúçÔºö</label>
                    <div class="date-inputs">
                        <input type="date" id="conversations-start" value="{{ default_dates.month_ago }}">
                        <span>Ëá≥</span>
                        <input type="date" id="conversations-end" value="{{ default_dates.today }}">
                    </div>
                </div>
                
                <button class="export-btn" onclick="exportData('conversations')">
                    ÂåØÂá∫Â∞çË©±Ë®òÈåÑ
                </button>
            </div>
            
            <!-- Â≠∏ÁøíÂàÜÊûêÂ†±Âëä -->
            <div class="export-card">
                <h3 data-icon="üìà">Â≠∏ÁøíÂàÜÊûêÂ†±Âëä</h3>
                <p>ÂåØÂá∫Â≠∏ÁîüÂ≠∏ÁøíÈÄ≤Â∫¶ÂíåÂèÉËàáÂ∫¶ÂàÜÊûê</p>
                
                <div class="format-options">
                    <button class="format-btn selected" data-format="pdf">PDF</button>
                    <button class="format-btn" data-format="excel">Excel</button>
                    <button class="format-btn" data-format="pptx">PowerPoint</button>
                </div>
                
                <div class="date-range">
                    <label>ÂàÜÊûêÊúüÈñìÔºö</label>
                    <div class="date-inputs">
                        <input type="date" id="analysis-start" value="{{ default_dates.semester_start }}">
                        <span>Ëá≥</span>
                        <input type="date" id="analysis-end" value="{{ default_dates.today }}">
                    </div>
                </div>
                
                <button class="export-btn" onclick="exportData('analysis')">
                    ÂåØÂá∫ÂàÜÊûêÂ†±Âëä
                </button>
            </div>
            
            <!-- ÊïôÂ≠∏ÊàêÊïàÁµ±Ë®à -->
            <div class="export-card">
                <h3 data-icon="üéØ">ÊïôÂ≠∏ÊàêÊïàÁµ±Ë®à</h3>
                <p>ÂåØÂá∫Ë™≤Á®ãÊï¥È´îÊàêÊïàÂíåÊîπÈÄ≤Âª∫Ë≠∞</p>
                
                <div class="format-options">
                    <button class="format-btn selected" data-format="excel">Excel</button>
                    <button class="format-btn" data-format="csv">CSV</button>
                    <button class="format-btn" data-format="json">JSON</button>
                </div>
                
                <div class="date-range">
                    <label>Áµ±Ë®àÊúüÈñìÔºö</label>
                    <div class="date-inputs">
                        <input type="date" id="effectiveness-start" value="{{ default_dates.semester_start }}">
                        <span>Ëá≥</span>
                        <input type="date" id="effectiveness-end" value="{{ default_dates.today }}">
                    </div>
                </div>
                
                <button class="export-btn" onclick="exportData('effectiveness')">
                    ÂåØÂá∫ÊàêÊïàÁµ±Ë®à
                </button>
            </div>
            
            <!-- ÂÆåÊï¥Ë≥áÊñôÂÇô‰ªΩ -->
            <div class="export-card">
                <h3 data-icon="üíæ">ÂÆåÊï¥Ë≥áÊñôÂÇô‰ªΩ</h3>
                <p>ÂåØÂá∫Á≥ªÁµ±ÊâÄÊúâË≥áÊñô‰ΩúÁÇ∫ÂÆåÊï¥ÂÇô‰ªΩ</p>
                
                <div class="format-options">
                    <button class="format-btn selected" data-format="zip">ZIP Â£ìÁ∏ÆÊ™î</button>
                    <button class="format-btn" data-format="sql">SQL ÂÇô‰ªΩ</button>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                    <strong>Ê≥®ÊÑèÔºö</strong>ÂÆåÊï¥ÂÇô‰ªΩÂèØËÉΩÈúÄË¶ÅËºÉÈï∑ÊôÇÈñìÔºåÂª∫Ë≠∞Âú®Á≥ªÁµ±ÈñíÁΩÆÊôÇÈÄ≤Ë°å„ÄÇ
                </div>
                
                <button class="export-btn" onclick="exportData('full_backup')">
                    ÈñãÂßãÂÆåÊï¥ÂÇô‰ªΩ
                </button>
            </div>
        </div>
        
        <!-- ÈÄ≤ÈöéÈÅ∏È†Ö -->
        <div class="advanced-options">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">‚öôÔ∏è ÈÄ≤ÈöéÂåØÂá∫ÈÅ∏È†Ö</h2>
            
            <div class="option-group">
                <label>Ë≥áÊñôÁØ©ÈÅ∏Ôºö</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-active" checked>
                        <label for="filter-active">ÂÉÖÊ¥ªË∫çÂ≠∏Áîü</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-complete" checked>
                        <label for="filter-complete">ÂÆåÊï¥Â∞çË©±Ë®òÈåÑ</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-analysis">
                        <label for="filter-analysis">ÂåÖÂê´ AI ÂàÜÊûê</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-metadata">
                        <label for="filter-metadata">ÂåÖÂê´ÂÖÉË≥áÊñô</label>
                    </div>
                </div>
            </div>
            
            <div class="option-group">
                <label>ÂåØÂá∫Ê†ºÂºèË®≠ÂÆöÔºö</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="format-timestamps" checked>
                        <label for="format-timestamps">ÂåÖÂê´ÊôÇÈñìÊà≥Ë®ò</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="format-charts">
                        <label for="format-charts">ÂåÖÂê´ÂúñË°®</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="format-summary" checked>
                        <label for="format-summary">ÂåÖÂê´ÊëòË¶Å</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="format-compress">
                        <label for="format-compress">Â£ìÁ∏ÆÊ™îÊ°à</label>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÂåØÂá∫ÈÄ≤Â∫¶ -->
        <div class="progress-section">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">üîÑ ÂåØÂá∫ÈÄ≤Â∫¶</h2>
            
            {% if export_jobs %}
            {% for job in export_jobs %}
            <div class="progress-item status-{{ job.status }}">
                <div class="progress-icon">
                    {% if job.status == 'complete' %}‚úÖ
                    {% elif job.status == 'processing' %}‚è≥
                    {% elif job.status == 'error' %}‚ùå
                    {% else %}‚è∏Ô∏è{% endif %}
                </div>
                <div class="progress-info">
                    <h4>{{ job.name }}</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ job.progress }}%;"></div>
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d;">
                        {{ job.description }} - {{ job.progress }}%
                    </div>
                </div>
                {% if job.status == 'complete' %}
                <a href="{{ job.download_url }}" class="download-link">‰∏ãËºâ</a>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                ÁõÆÂâçÊ≤íÊúâÈÄ≤Ë°å‰∏≠ÁöÑÂåØÂá∫‰ΩúÊ•≠
            </div>
            {% endif %}
        </div>
        
        <!-- ÂåØÂá∫Ê≠∑Âè≤ -->
        <div class="history-section">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">üìö ÂåØÂá∫Ê≠∑Âè≤</h2>
            
            {% if export_history %}
            {% for item in export_history %}
            <div class="history-item">
                <div class="history-info">
                    <h4>{{ item.name }}</h4>
                    <div class="history-meta">
                        {{ item.created_at.strftime('%Y-%m-%d %H:%M') }} | 
                        {{ item.file_size }} | 
                        {{ item.format.upper() }}
                    </div>
                </div>
                <div class="history-actions">
                    {% if item.available %}
                    <button class="action-btn btn-download" onclick="downloadFile('{{ item.file_path }}')">
                        ‰∏ãËºâ
                    </button>
                    <button class="action-btn btn-share" onclick="shareFile('{{ item.id }}')">
                        ÂàÜ‰∫´
                    </button>
                    {% endif %}
                    <button class="action-btn btn-delete" onclick="deleteFile('{{ item.id }}')">
                        Âà™Èô§
                    </button>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div style="text-align: center; color: #7f8c8d; padding: 40px;">
                Â∞öÊú™ÊúâÂåØÂá∫Ë®òÈåÑ
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Ê†ºÂºèÈÅ∏Êìá
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // ÁßªÈô§ÂêåÁµÑÂÖ∂‰ªñÊåâÈàïÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
                this.parentNode.querySelectorAll('.format-btn').forEach(b => b.classList.remove('selected'));
                // ÈÅ∏‰∏≠Áï∂ÂâçÊåâÈàï
                this.classList.add('selected');
            });
        });
        
        // ÂåØÂá∫Ë≥áÊñô
        function exportData(type) {
            const card = event.target.closest('.export-card');
            const format = card.querySelector('.format-btn.selected').dataset.format;
            const startDate = card.querySelector('input[type="date"]:first-of-type').value;
            const endDate = card.querySelector('input[type="date"]:last-of-type').value;
            
            // Êî∂ÈõÜÈÄ≤ÈöéÈÅ∏È†Ö
            const filters = {
                active_only: document.getElementById('filter-active').checked,
                complete_only: document.getElementById('filter-complete').checked,
                include_analysis: document.getElementById('filter-analysis').checked,
                include_metadata: document.getElementById('filter-metadata').checked,
                include_timestamps: document.getElementById('format-timestamps').checked,
                include_charts: document.getElementById('format-charts').checked,
                include_summary: document.getElementById('format-summary').checked,
                compress: document.getElementById('format-compress').checked
            };
            
            // È°ØÁ§∫ÈÄ≤Â∫¶ÊèêÁ§∫
            showExportProgress(`Ê≠£Âú®Ê∫ñÂÇô ${getTypeName(type)} ÂåØÂá∫...`);
            
            // ÁôºÈÄÅÂåØÂá∫Ë´ãÊ±Ç
            fetch('/api/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: type,
                    format: format,
                    start_date: startDate,
                    end_date: endDate,
                    filters: filters
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(`${getTypeName(type)} ÂåØÂá∫Â∑≤ÈñãÂßãÔºåË´ãÂú®ÈÄ≤Â∫¶ÂçÄÂüüÊü•ÁúãÁãÄÊÖã`);
                    // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢‰ª•Êõ¥Êñ∞ÈÄ≤Â∫¶
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showError(`ÂåØÂá∫Â§±ÊïóÔºö${data.error}`);
                }
            })
            .catch(error => {
                showError(`ÂåØÂá∫ÈÅéÁ®ãÁôºÁîüÈåØË™§Ôºö${error.message}`);
            });
        }
        
        function getTypeName(type) {
            const names = {
                'conversations': 'Â∞çË©±Ë®òÈåÑ',
                'analysis': 'ÂàÜÊûêÂ†±Âëä',
                'effectiveness': 'ÊàêÊïàÁµ±Ë®à',
                'full_backup': 'ÂÆåÊï¥ÂÇô‰ªΩ'
            };
            return names[type] || type;
        }
        
        function showExportProgress(message) {
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 30px;
                border-radius: 15px;
                text-align: center;
                z-index: 1000;
            `;
            progressDiv.innerHTML = `
                <div style="font-size: 1.2em; margin-bottom: 20px;">${message}</div>
                <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;">
                    <div style="width: 0%; height: 100%; background: #f093fb; border-radius: 2px; animation: loading 2s ease-in-out infinite;" id="exportProgressBar"></div>
                </div>
                <style>
                @keyframes loading {
                    0%, 100% { width: 0%; }
                    50% { width: 100%; }
                }
                </style>
            `;
            document.body.appendChild(progressDiv);
            
            // 2ÁßíÂæåÁßªÈô§
            setTimeout(() => {
                if (document.body.contains(progressDiv)) {
                    document.body.removeChild(progressDiv);
                }
            }, 2000);
        }
        
        function showSuccess(message) {
            showNotification(message, 'success');
        }
        
        function showError(message) {
            showNotification(message, 'error');
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            const color = type === 'success' ? '#27ae60' : '#e74c3c';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 1001;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 4000);
        }
        
        function downloadFile(filePath) {
            window.open(`/api/download/${encodeURIComponent(filePath)}`, '_blank');
        }
        
        function shareFile(fileId) {
            // ÁîüÊàêÂàÜ‰∫´ÈÄ£Áµê
            const shareUrl = `${window.location.origin}/api/share/${fileId}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                showSuccess('ÂàÜ‰∫´ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
            }).catch(() => {
                prompt('ÂàÜ‰∫´ÈÄ£ÁµêÔºö', shareUrl);
            });
        }
        
        function deleteFile(fileId) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊ™îÊ°àÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                fetch(`/api/export/${fileId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Ê™îÊ°àÂ∑≤Âà™Èô§');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showError('Âà™Èô§Â§±ÊïóÔºö' + data.error);
                    }
                })
                .catch(error => {
                    showError('Âà™Èô§ÈÅéÁ®ãÁôºÁîüÈåØË™§');
                });
            }
        }
        
        // ÂÆöÊúüÊõ¥Êñ∞ÈÄ≤Â∫¶
        setInterval(() => {
            fetch('/api/export-status')
                .then(response => response.json())
                .then(data => {
                    // Êõ¥Êñ∞ÈÄ≤Â∫¶Ê¢ù
                    data.jobs.forEach(job => {
                        const progressBar = document.querySelector(`[data-job-id="${job.id}"] .progress-fill`);
                        if (progressBar) {
                            progressBar.style.width = `${job.progress}%`;
                        }
                    });
                })
                .catch(error => console.error('Êõ¥Êñ∞ÈÄ≤Â∫¶Â§±Êïó:', error));
        }, 5000);
    </script>
</body>
</html>
"""

# Ê®°ÊùøÁÆ°ÁêÜÂ∑•ÂÖ∑ÂáΩÊï∏
def get_template(template_name):
    """ÂèñÂæóÊåáÂÆöÊ®°Êùø"""
    templates = {
        'storage_management.html': STORAGE_MANAGEMENT_TEMPLATE,
        'data_export.html': DATA_EXPORT_TEMPLATE,
    }
    return templates.get(template_name, '<h1>Ê®°ÊùøÊú™ÊâæÂà∞</h1>')

# ÂåØÂá∫ÊâÄÊúâÊ®°Êùø
__all__ = [
    'STORAGE_MANAGEMENT_TEMPLATE',
    'DATA_EXPORT_TEMPLATE',
    'get_template'
]
